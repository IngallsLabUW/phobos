---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# phobos

<!-- badges: start -->
<!-- badges: end -->

phobos is a package comprising of custom functions that accompany the Ingalls Lab MARS Project.

The MARS project is an easy way to identify and rank unknown mass features (MFs) in your data. It consists of three major sections: 

- A central database containing compiled unknown mass features with mz (mass/charge), rt (retention time, seconds) and ms2 data detected by the Ingalls lab 
- *phobos*: A series of processes and functions for annotating, ranking, and scoring the unknown mass features
- A central database containing annotated mass features from previous MARS missions

Flexible, updatable, searchable, rankable, exportable. 


## Installation

You can install the development version of phobos from [Github](https://github.com) with:

``` r
devtools::install_github("IngallsLabUW/phobos")
```

Load phobos:

``` r
install.packages("phobos")
```

## Description

A common problem in metabolomics is how to handle unknown but determinable mass features. The output of non-targeted metabolite runs produces an abundance of spectra that can be discretely separated and isolated, but often remain unidentified. 

The phobos package, designed as part of the Ingalls MARS Project *TODO LINK TO FUTURE GITHUB WEBSITE HERE?*, prioritizes simplicity, efficiency, and confidence in metabolite identification. phobos adheres to the proposed minimum reporting standards for chemical analysis as laid out in the Metabolomics Standards Initiative (MSI) [2007 paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3772505/pdf/nihms504189.pdf). In addition to utilizing the [Ingalls Lab Standards](https://github.com/IngallsLabUW/Ingalls_Standards) for foremost confidence annotations, phobos provides functionality for incorporating spectral comparison to third-party sources such as [MassBank of North America (MoNA)](https://mona.fiehnlab.ucdavis.edu/, [Metlin](https://metlin.scripps.edu/landing_page.php?pgcontent=mainPage), *TODO METLIN TBD* and [KEGG](https://www.genome.jp/kegg/) *TODO KEGG TBD*.

*Maybe can remove this section?*
There are currently several available packages in R that handle metabolite identification, including the well-established [xcms](https://bioconductor.org/packages/release/bioc/html/xcms.html), as well as newly-released packages such as [RHermes](https://rogerginber.github.io/RHermes/articles/RHermes_UserGuide.html). 

## Usage

phobos simplifies the identification process by transforming the MSI standards [paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3772505/pdf/nihms504189.pdf) into steps for annotation. Users begin with experimental (unknown) values, and systematically compare those values to various dataframes of theoretical (known) values. Each step corresponds to a custom phobos function.

```{r load data, echo=FALSE}
library(tidyverse)
options(digits = 2)
experimental.values <- read.csv("example_data/Example_Experimental_Data.csv") 
experimental.values$MS2 <- sub("^([^;]+;[^;]+).*", "\\1", experimental.values$MS2)

theoretical.values <- read.csv("example_data/Theoretical_Data.csv") %>%
  select(-file_name)
theoretical.values$MS2 <- sub("^([^;]+;[^;]+).*", "\\1", theoretical.values$MS2)
```

The user begins with a dataframe of experimental data, transformed *by the user* into a standardized format. It is important to pay attention to both the column names and the class; the code will not run if they are not in the correct configuration!

- "MassFeature": An identifier for a unique mass feature, character. 
- "mz": The mz value, numeric. 
- "rt": The retention time, in seconds, numeric. 
- "column": Column the mass feature was run on, character. 
- "z": The ion mode, numeric. 
- "MS2": MS2 data for those compounds that have it, character. 
  - **Important**: The MS2 data must be in the filtered, scaled and concatenated format of "mz, intensity;", as below. For example purposes, the MS2 column has been cut off at two instances of "mz, intensity;" but real data should have many more entries. For more information on how to get your MS2 data into the correct format, *TODO PUT INFORMATION HERE*.
  
For clarity, phobos also adds an additional identifier column to the dataframe titled "compound_experimental": a simple keys column consisting of 1-n rows.

```{r example}
library(phobos)

knitr::kable(head(experimental.values, 5), caption = "Experimental Data")
knitr::kable(theoretical.values[c(1, 9, 18, 25), ], caption = "Theoretical Data")

```

---
### Confidence Level 1
Create a dataframe annotated for Confidence Level 1 by comparing experimental and theoretical data, using the AnnotateConfidenceLevel1() function.

```{r Confidence Level 1}
Confidence.Level.1 <- AnnotateConfidenceLevel1(experimental.values = experimental.values, theoretical.values = theoretical.values, 
                                             mz.flexibility = 0.02, rt.flexibility = 30)
```

*TODO: fix display of this table* 
```{r Display CL1}
knitr::kable(head(Confidence.Level.1, 10))
```

---
### Confidence Level 2

Compounds that receive a confidence level of 2 are considered putatively annotated compounds: there are no available chemical reference standards, but they have good MS1 and MS2 spectral similarity with public/commercial spectral libraries. External libraries used for confidence level 2 are MoNA and Metlin. 

The comparison MoNA spectra can be downloaded directly from the [public website](https://mona.fiehnlab.ucdavis.edu/downloads). Unlike the Ingalls Standards sheets, the downloaded MoNA sheets require transformation from JSON to csv, and are large enough to need external storage. The code to transform the JSONs to csvs is included in the phobos package. The pre-downloaded and cleaned MoNA csvs live on the shared Ingalls Google Drive [MARS project](https://drive.google.com/drive/folders/1lzIsDJJ7EyDpJrCTLdspHc0KS6zxUIDQ) folder.

```{r load CL2 data, echo=FALSE}
Confidence.Level.1 <- read.csv("example_data/Example_ConfidenceLevel1.csv") 
```

```{r Confidence Level 2}
Confidence.Level.2 <- AnnotateMoNAConfidenceLevel2(Confidence.Level.1 = Confidence.Level.1, mz.flexibility = 0.02, rt.flexibility = 30)
```

---
### Confidence Level 3

Compounds that receive a confidence level of 3 are also considered putatively annotated with fewer restrictions. The MARS project and the phobos package define a confidence level 3 as an MS1 match from MoNA, Metlin or KEGG.

---
### Confidence Level 4

Confidence level 4 is everything else. It should be filtered for possible contaminants and made sure that the potential mass feature is quality. 


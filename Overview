**********Overall Questions**********

Functions are less flexible, and exist in script form rather than package form (or sourced file form) due to time restraints. If we want to change that setup, some functions will need to be checked and made applicable to all confidence levels. They currently can't live outside their script.

We might want to reconsider the voltages and those interact with the matching, particularly after confidence level1 (?). They are still creating big row explosions like before and slowing stuff down in general.

Acquiring the external stuff is going to take some work.

**********Set up data**********

In order to ensure that the MS2 (and MS1, rt, etc.) matching is accurate, we need to be comparing known data before we compare unknowns.
Horai et al. 2010 recommends taking a consensus of MS2 data for comparison, as reproducibility of MS2 data is notoriously difficult.

Therefore, we ran all of the Ingalls Standards 5 times (thanks Laura) and obtained five sets of MS2 data for each compound.
We then took a consensus of four of the runs to create "theoretical data"; i.e, something to compare the fifth run to for accuracy.
Because the fifth run is being compared to very similar runs, that removes variation that might interfere with comparisons.

Taking a consensus of the MS2 data:
- The data is scaled to an intensity of 100 and all intensities below 0.5 are removed.
- Fragments are grouped exclusively on mz, and assigned a group number for those that fall within a user-defined ppm range.
- Find clusters that are robust across files using hierarchical clustering in mz space, and cut the tree at a height that produces
  the most groups with 5 +/-1 fragments, or 10 +/- fragments to account for "superimposed lollipops" (ask Will).


**********Confidence Level 1**********
Requires a good match to a known chemical standard.

Tidy and setup
- Make sure all inputs (experimental and theoretical) are in a standardized format.

Process
- Apply comparison function to each row (each compound @ each voltage) of the experimetnal data frame.
- Filter the potential matches on m/z by user-defined ppm error.
- Match polarity and column.
- Rowwise:
  MS1 (m/z) and retention time (RT) Similarity Scores: exp(-0.5 * (((experimental value - theoretical value) / user-defined flexibility) ^ 2))
  MS2 cosine similarity. If both sets of MS2 values are present, calculate the similarity using the 2015 MSDial paper similarity equations.
  Total Similarity Score, according to which other similarity scores are present, also taken from 2015 MSDial paper.


**********Confidence Level 2: MoNA**********

Download the MoNA positive and negative spectra from the website. This is downloaded as a JSON and the code is written (I think) to convert it, but it's very out of date and probably isn't in the most practical layout. Tidied spreadsheets of the data are in package/google drive.

Tidy and setup external data (a lot of this can probably be done before)
- Subtract or add hydrogen (1.0072766) from the MoNA mass for reference
- Tidy spectra, dropping NA or blank MS2s

Tidy and setup experimental spectra
- Isolate experimental observations that actually have MS2 data
- Wrangle mz, MS2, and primary key into appropriate shapes for upcoming transformations

Assign variables from theoretical and experimental for parallelized comparison (otherwise it takes, literally, forever). Unfortunately I have only done this for Macs :D

First do an mz comparison with MoNA (this step has a lot of issues with it, honestly I think it should probably be completely rewritten, particularly from a unit-test perspective):
- For some reason, I do a filtering step that I think is redundant.
- Do another fuzzy join on a (no!) hardcoded 0.02 value between experimental data and MoNA
- Filter for the correct polarity
- rename a bunch of columns so MS2 cosine similarity functions can be applied (i think some of this renaming is unnecessary)
- Add a quick check if there are no potential matches on ms1 (aka, if there isn't a good match to ms1 we don't try to do similarity on ms2)

MS2 comparison (this step is bundled in with the above step as one kind of unwieldy function, as well as the filters below. Should probably be split.)
- Same MS2 cosine calculation as CL1, just written to handle the new columns.
- Calculate ppm error: massbank_ppm = abs(mass2 - mass1) / mass1 * 10^6)
- Filter out matches that fall below a hardcoded ppm filter of 7, and a hardcoded ms2 cosine similiarty of 0.5

Return those experimental observations that had matches (this is also bundled up, maybe should be its own thing) and then rejoin those matches with the full confidence level 1 dataframe.
Mutate mz similarity score, same calculations as above, for MoNa mz similarity matches.
BUG FOUND HERE: For some strange reason, I add a second ms2 cosine similarity calculation here, but only if there s more than one set of mz:intensity measurements in the massbank ms2 data.
Mutate a second total similarity score that does not include retention time similarity (KRH advised against using RT due to Rt variation across labs).
BUG FOUND HERE: Create confidence rank of 2 if the mz similarity score of 2 is greater than 0.9. There is no input of ms2 for some reason. Also create confidence source from MoNA.

**********MoNA Confidence Level 3 breakdown**********

Reimport experimental values from previously annotated dataset. Probably not necessary, annotation should be independent. This step does involve removing experimental values that have two potential matches but no source.

Tidy mona spectra (probably is redundant)
- Add a "z" column to massbank.
BUG FOUND - Make MH mass by subtracting hydrogen, but forgot to do it for the positive ones.

Comparisons
- Do our usual fuzzy join on the hardcoded value.
- Filter for appropriate z
- Rename columns as necessary
- calculate mh_mass similarity score with normal calcs

Do the same sanity checks as in CL1, basically make sure you haven't lost any compounds. Could be more lightweight.
Rejoin with your CL2 data.
Create ppm mass error.
Make confidence rank of 3 if mz_similarity_score3 > 0.9 & ppm_mass_error3 < 7
Tidy and export


**********KEGG Confidence Level 3 breakdown**********

Will wrote the code to get KEGG info but it hasn't been run in a while. I will update that. In the meantime the tidied premade set (which may or may not be reproducible) is on the google drive and in the example data.

Set mz flexibility to 0.02 and ppm tolerance to 15
Reimport cl3mona stuff (probably unnecessary) and prep for comparison

Tidy KEGG and add z and column info.

Do a fuzzyjoin (and this time its not hardcoded wtf)

Mutate ppm and similarity score (didn't use functions for some reason)

Filter for z and ppm scores that fall outside of user-defined bounds.

Join the matched KEGG Ids with the full names.

Mutate rank ifelse(mz_similarity_scoreKEGG > 0.9, 3, NA)). Doesn't include ppm as a filtering.



**********Confidence Level 4 breakdown**********

Literally everything else. Maybe 4 should have some kind of consistency or metrics rather than "literally everything else"


